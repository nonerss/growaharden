--[[ 
üìú Grow a Garden Old Server Finder v1.4
üß† New logic: filter by placeVersion (old servers have lower version)
üéÆ Use with KRNL in Grow a Garden session
]]

-- ‚úÖ Real game place ID
local customPlaceId = 14537007450

-- üîß Services
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local UIS = game:GetService("UserInputService")
local Chat = game:GetService("StarterGui")

-- üìå Wait for PlayerGui
local Player = Players.LocalPlayer
repeat wait() until Player and Player:FindFirstChild("PlayerGui")

-- üìã Current server version
local currentVersion = game.PlaceVersion

-- üí¨ Log helper
local function log(msg)
    Chat:SetCore("ChatMakeSystemMessage", {
        Text = "[OldFinder] " .. msg,
        Color = Color3.fromRGB(0, 255, 0)
    })
end

log("Current server version: " .. tostring(currentVersion))

-- üßπ Remove previous GUI if exists
pcall(function()
    Player.PlayerGui.OldServerUI:Destroy()
end)

-- üé® GUI Setup
local gui = Instance.new("ScreenGui", Player.PlayerGui)
gui.Name = "OldServerUI"
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 400, 0, 420)
frame.Position = UDim2.new(0.5, -200, 0.5, -210)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.Active = true
frame.Draggable = true

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1, -40, 0, 40)
title.Position = UDim2.new(0, 10, 0, 0)
title.Text = "üå± Grow a Garden - Old Server Finder (v" .. tostring(currentVersion) .. ")"
title.TextColor3 = Color3.new(1,1,1)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.TextSize = 18
title.TextXAlignment = Enum.TextXAlignment.Left

local minimize = Instance.new("TextButton", frame)
minimize.Size = UDim2.new(0, 30, 0, 30)
minimize.Position = UDim2.new(1, -35, 0, 5)
minimize.Text = "-"
minimize.Font = Enum.Font.GothamBold
minimize.TextSize = 22
minimize.BackgroundColor3 = Color3.fromRGB(60,60,60)
minimize.TextColor3 = Color3.new(1,1,1)

local content = Instance.new("Frame", frame)
content.Position = UDim2.new(0, 10, 0, 45)
content.Size = UDim2.new(1, -20, 1, -55)
content.BackgroundTransparency = 1

local layout = Instance.new("UIListLayout", content)
layout.Padding = UDim.new(0, 5)

local fetchBtn = Instance.new("TextButton", content)
fetchBtn.Size = UDim2.new(1, 0, 0, 40)
fetchBtn.BackgroundColor3 = Color3.fromRGB(50,150,50)
fetchBtn.TextColor3 = Color3.new(1,1,1)
fetchBtn.Text = "üîç Show Old Servers (v < " .. tostring(currentVersion) .. ")"
fetchBtn.Font = Enum.Font.GothamBold
fetchBtn.TextSize = 16

-- üîÅ Fetch logic
local function fetchServers()
    for _, c in ipairs(content:GetChildren()) do
        if c:IsA("TextButton") and c ~= fetchBtn then
            c:Destroy()
        end
    end

    fetchBtn.Text = "Loading..."
    log("Fetching server list...")

    local ok, raw = pcall(function()
        return game:HttpGet(("https://games.roblox.com/v1/games/%s/servers/Public?sortOrder=Asc&limit=100"):format(customPlaceId))
    end)

    log("HTTPGet ok: " .. tostring(ok))
    if not ok or not raw then
        fetchBtn.Text = "‚ùå Failed. Retry"
        log("Fetch failed. Retrying in 5s...")
        task.delay(5, fetchServers)
        return
    end

    local data, err = nil, nil
    local decodeOk = pcall(function()
        data = HttpService:JSONDecode(raw)
    end)

    if not decodeOk or not data or not data.data then
        fetchBtn.Text = "‚ùå Invalid data"
        log("JSON decode failed. Retrying in 5s...")
        task.delay(5, fetchServers)
        return
    end

    local list = {}
    for _, s in ipairs(data.data) do
        if s.playing < s.maxPlayers and s.version and s.version < currentVersion then
            table.insert(list, s)
        end
    end

    table.sort(list, function(a,b) return a.version < b.version end)

    if #list == 0 then
        fetchBtn.Text = "No old servers found"
        log("No outdated servers available.")
        return
    end

    for i = 1, math.min(5, #list) do
        local s = list[i]
        local age = tick() - DateTime.fromIsoDate(s.created):ToUnixTimestamp()
        local ageText = age >= 3600 and string.format("%.1f hr", age/3600) or (math.floor(age/60) .. " min")
        -- label for version
        local verLabel = "v" .. tostring(s.version)

        local btn = Instance.new("TextButton", content)
        btn.Size = UDim2.new(1, 0, 0, 35)
        btn.BackgroundColor3 = Color3.fromRGB(40,40,40)
        btn.TextColor3 = Color3.new(1,1,1)
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 14
        btn.Text = string.format("%s | %s old | %d/%d | %s", verLabel, ageText, s.playing, s.maxPlayers, "Join")
        btn.MouseButton1Click:Connect(function()
            TeleportService:TeleportToPlaceInstance(customPlaceId, s.id, Player)
        end)
    end

    local refresh = Instance.new("TextButton", content)
    refresh.Size = UDim2.new(1, 0, 0, 35)
    refresh.BackgroundColor3 = Color3.fromRGB(80,80,80)
    refresh.TextColor3 = Color3.new(1,1,1)
    refresh.Font = Enum.Font.Gotham
    refresh.TextSize = 14
    refresh.Text = "üîÅ Refresh"
    refresh.MouseButton1Click:Connect(fetchServers)

    fetchBtn.Text = "üîç Show Old Servers"
    log("Displayed " .. #list .. " old servers.")
end

fetchBtn.MouseButton1Click:Connect(fetchServers)

-- ‚å®Ô∏è G key to toggle GUI
UIS.InputBegan:Connect(function(input, gp)
    if not gp and input.KeyCode == Enum.KeyCode.G then
        gui.Enabled = not gui.Enabled
        log("G toggled GUI: " .. tostring(gui.Enabled))
    end
end)

-- üóï Minimize button
local hidden = false
minimize.MouseButton1Click:Connect(function()
    hidden = not hidden
    content.Visible = not hidden
    log(hidden and "Window minimized." or "Window expanded.")
end)
